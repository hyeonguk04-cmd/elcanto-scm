# 파셜 입고(Partial Arrival) 기능 가이드

## 📦 개요

파셜 입고 기능은 발주 건이 여러 번에 걸쳐 분할 입고되는 경우를 관리하는 기능입니다.

### 주요 특징
- 최대 3회 분할 입고 지원 (필요시 확장 가능)
- 실시간 누적 수량 및 진행률 자동 계산
- 4단계 색상 코드로 직관적 상태 표시
- UI 모달과 엑셀 업로드 두 가지 방식 지원

---

## 🎯 사용 방법

### 방법 1: UI 모달로 개별 입고 등록

#### 공정 입고진척 현황 페이지
1. 메뉴에서 **"공정 입고진척 현황"** 선택
2. 입고현황 컬럼에서 **[입고등록]** 버튼 클릭
3. 입고 정보 입력:
   - 입고일: YYYY-MM-DD 형식
   - 입고수량: 숫자 입력
   - 비고 (선택): 특이사항 기록
4. 실시간 미리보기에서 결과 확인
5. **[등록]** 버튼 클릭

#### 입고 이력 확인 및 수정
1. **[이력보기]** 버튼 클릭
2. 전체 입고 이력 확인
3. 필요시 **[수정]** 또는 **[삭제]** (최근 입고만)

---

### 방법 2: 엑셀로 대량 입고 업로드

#### 공정별 완료일 등록 페이지
1. 메뉴에서 **"공정별 완료일 등록"** 선택
2. **[템플릿 다운로드]** 버튼 클릭
3. 엑셀 파일 작성:
   - 기본 정보: 채널, 스타일, 색상 등
   - 공정 완료일: 각 공정별 완료일 입력
   - **입고 정보**:
     - `입고일_1차`, `입고수량_1차`
     - `입고일_2차`, `입고수량_2차`
     - `입고일_3차`, `입고수량_3차`
4. **[엑셀 업로드]** 버튼 클릭
5. 자동 처리 확인

#### 엑셀 작성 예시
```
스타일    | 색상  | 수량 | 입고일_1차  | 입고수량_1차 | 입고일_2차  | 입고수량_2차 | 입고일_3차  | 입고수량_3차
ABC1234567| BLACK | 1000 | 2026-01-02  | 500         | 2026-01-05  | 300         | 2026-01-08  | 200
```

---

## 🎨 4단계 상태 코드

| 이모지 | 상태 | 진행률 | 설명 |
|--------|------|--------|------|
| 🔴 | 미입고 | 0% | 입고 기록 없음 |
| 🟡 | 파셜입고 | 1-99% | 부분 입고 진행 중 |
| 🟢 | 입고완료 | 100% | 발주 수량 전부 입고 |
| 🔵 | 초과입고 | 101%+ | 발주 수량 초과 입고 |

---

## 📊 데이터 구조

### Firestore 문서 구조
```javascript
{
  // 기존 필드들...
  "quantity": 1000,
  
  // 입고 관련 필드 (자동 추가)
  "arrivals": [
    {
      "date": "2026-01-02",
      "quantity": 500,
      "cumulative": 500,
      "note": "1차 입고",
      "createdAt": Timestamp,
      "createdBy": "user123"
    },
    {
      "date": "2026-01-05",
      "quantity": 300,
      "cumulative": 800,
      "note": "2차 입고",
      "createdAt": Timestamp,
      "createdBy": "user123"
    }
  ],
  
  // 자동 계산 필드
  "firstArrival": {
    "date": "2026-01-02",
    "quantity": 500
  },
  "lastArrival": {
    "date": "2026-01-05",
    "quantity": 300
  },
  "arrivalSummary": {
    "totalReceived": 800,
    "progress": 80,
    "count": 2,
    "status": "partial"
  }
}
```

---

## 🔧 마이그레이션

### 기존 데이터 마이그레이션
```bash
# 1. 스크립트 실행
cd /home/user/webapp
node scripts/migrate-add-arrivals.js

# 2. 확인 프롬프트
⚠️  주의: 이 스크립트는 모든 주문 문서를 수정합니다.
계속 진행하시겠습니까? (yes/no): yes

# 3. 결과 확인
✅ 마이그레이션 완료: XXX건
⏭️  스킵: XXX건 (이미 존재)
```

### Firebase 인덱스 배포
```bash
# 인덱스 정의 배포
firebase deploy --only firestore:indexes

# 배포 후 Firebase Console에서 인덱스 생성 상태 확인
# https://console.firebase.google.com/project/YOUR-PROJECT/firestore/indexes
```

---

## ⚠️ 주의사항

### 엑셀 업로드 시
1. **기존 데이터 보존**
   - 이미 등록된 공정 완료일은 덮어쓰지 않음
   - 새로운 데이터만 추가됨
   
2. **중복 입고 방지**
   - 동일한 날짜 + 수량 조합은 자동으로 스킵
   
3. **초과 입고 경고**
   - 누적 수량이 발주 수량을 초과하면 경고 표시
   - 등록은 허용됨 (실제 상황 반영)

### 입고 삭제
- 최근 입고 기록만 삭제 가능
- 중간 입고 기록은 수정만 가능
- 삭제 시 자동으로 누적 수량 재계산

---

## 📈 비용 분석

### Firebase 비용
- **연간 추가 비용**: $0.17 (무시할 수준)
- **5배 성장 시**: $0.86/년
- **ROI**: 525% (투자 대비 회수율)
- **회수 기간**: 2.3개월

### 계산 근거
```
현재 주문 수: 300건
파셜 입고 비율: 15%
평균 분할 횟수: 2.5회

월간 추가 작업:
- 읽기: 450회 × $0.06/100,000 = $0.00027
- 쓰기: 450회 × $0.18/100,000 = $0.00081
- 저장: 0.05MB × $0.18/GB = $0.000009

연간 총 비용: $0.17
```

---

## 🐛 트러블슈팅

### 입고 등록 모달이 안 열림
- 브라우저 콘솔 확인
- `showArrivalRegistrationModal` 함수 import 확인

### 엑셀 업로드 시 오류
- 템플릿 다운로드 후 수정했는지 확인
- 날짜 형식: YYYY-MM-DD
- 수량 형식: 숫자만 입력

### 누적 수량이 안 맞음
- Firebase Console에서 arrivalSummary 확인
- 필요시 입고 이력 삭제 후 재등록

---

## 📞 지원

문제 발생 시:
1. 브라우저 콘솔 로그 확인
2. Firebase Console에서 데이터 확인
3. GitHub Issue 등록: https://github.com/hyeonguk04-cmd/elcanto-scm/issues

---

## 📝 변경 이력

### v1.0.0 (2026-01-21)
- ✅ 입고 관리 백엔드 함수 구현
- ✅ 입고 등록/이력 모달 UI
- ✅ 공정 입고진척 현황 페이지 업데이트
- ✅ 공정별 완료일 등록 페이지 업데이트
- ✅ 엑셀 대량 업로드 지원
- ✅ 4단계 색상 코드 시스템
