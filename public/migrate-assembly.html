<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Assembly ê³µì • ì œê±° ë§ˆì´ê·¸ë ˆì´ì…˜</title>
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getFirestore, collection, getDocs, doc, updateDoc, deleteDoc, writeBatch } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    // Firebase ì„¤ì • (firebase-config.jsì—ì„œ ê°€ì ¸ì˜¤ê¸°)
    const firebaseConfig = {
      apiKey: "AIzaSyALKVxJ7MQy5lQYEH0gU5-VCIXxK5xGVzE",
      authDomain: "elcanto-scm.firebaseapp.com",
      projectId: "elcanto-scm",
      storageBucket: "elcanto-scm.firebasestorage.app",
      messagingSenderId: "637249327661",
      appId: "1:637249327661:web:d4b0c3e0f8e1a9d1e1b7f1"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    window.migrateRemoveAssembly = async function() {
      const logEl = document.getElementById('log');
      const progressEl = document.getElementById('progress');
      
      function log(message, type = 'info') {
        const timestamp = new Date().toLocaleTimeString('ko-KR');
        const color = {
          'info': '#333',
          'success': '#10b981',
          'error': '#ef4444',
          'warning': '#f59e0b'
        }[type] || '#333';
        
        logEl.innerHTML += `<div style="color: ${color}; margin: 4px 0;">[${timestamp}] ${message}</div>`;
        logEl.scrollTop = logEl.scrollHeight;
      }

      try {
        log('ğŸš€ Assembly ê³µì • ì œê±° ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹œì‘...', 'info');
        log('', 'info');

        // ëª¨ë“  ë°œì£¼ ê°€ì ¸ì˜¤ê¸°
        const ordersSnapshot = await getDocs(collection(db, 'orders'));
        const totalOrders = ordersSnapshot.size;
        log(`ğŸ“¦ ì´ ${totalOrders}ê°œì˜ ë°œì£¼ ê±´ ë°œê²¬`, 'info');
        log('', 'info');

        let updatedCount = 0;
        let skippedCount = 0;
        let errorCount = 0;
        let current = 0;

        for (const orderDoc of ordersSnapshot.docs) {
          current++;
          const orderId = orderDoc.id;
          const orderData = orderDoc.data();
          
          progressEl.textContent = `ì§„í–‰ ì¤‘: ${current}/${totalOrders} (${Math.round(current/totalOrders*100)}%)`;
          
          log(`\nğŸ“‹ [${current}/${totalOrders}] ${orderId} (ìŠ¤íƒ€ì¼: ${orderData.style || 'N/A'})`, 'info');

          try {
            let hasAssembly = false;
            let newProduction = [];

            // schedule.production ë°°ì—´ì—ì„œ assembly ì œê±°
            if (orderData.schedule && orderData.schedule.production) {
              newProduction = orderData.schedule.production.filter(process => {
                const isAssembly = process.processKey === 'assembly' || 
                                   process.key === 'assembly' ||
                                   process.name === 'ì¡°ë¦½' ||
                                   process.name_en === 'Assembly' ||
                                   process.name_en === 'Assembly (Lasting)';
                
                if (isAssembly) {
                  log(`  âŒ ì œê±°: ${process.name || process.name_en || 'assembly'}`, 'warning');
                  hasAssembly = true;
                  return false;
                }
                return true;
              });
            }

            // processes ì„œë¸Œì»¬ë ‰ì…˜ í™•ì¸
            const processesSnapshot = await getDocs(collection(db, 'orders', orderId, 'processes'));
            const assemblyProcessDocs = [];

            for (const processDoc of processesSnapshot.docs) {
              const processData = processDoc.data();
              const isAssembly = processData.processKey === 'assembly' || 
                                processData.key === 'assembly' ||
                                processData.name === 'ì¡°ë¦½';
              
              if (isAssembly) {
                assemblyProcessDocs.push(processDoc);
                log(`  âŒ ì„œë¸Œì»¬ë ‰ì…˜ì—ì„œ ì œê±°: processes/${processDoc.id}`, 'warning');
              }
            }

            // ì—…ë°ì´íŠ¸ ì‹¤í–‰
            if (hasAssembly || assemblyProcessDocs.length > 0) {
              // ë©”ì¸ ë¬¸ì„œ ì—…ë°ì´íŠ¸
              if (hasAssembly) {
                await updateDoc(doc(db, 'orders', orderId), {
                  'schedule.production': newProduction
                });
              }

              // ì„œë¸Œì»¬ë ‰ì…˜ ë¬¸ì„œ ì‚­ì œ
              for (const processDoc of assemblyProcessDocs) {
                await deleteDoc(processDoc.ref);
              }

              log(`  âœ… ì—…ë°ì´íŠ¸ ì™„ë£Œ`, 'success');
              updatedCount++;
            } else {
              log(`  â­ï¸  Assembly ê³µì • ì—†ìŒ - ê±´ë„ˆëœ€`, 'info');
              skippedCount++;
            }

          } catch (error) {
            log(`  âš ï¸ ì˜¤ë¥˜: ${error.message}`, 'error');
            errorCount++;
          }

          // UI ì—…ë°ì´íŠ¸ë¥¼ ìœ„í•œ ì§§ì€ ëŒ€ê¸°
          await new Promise(resolve => setTimeout(resolve, 50));
        }

        // ê²°ê³¼ ìš”ì•½
        log('\n' + '='.repeat(60), 'info');
        log('ğŸ“Š ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ!', 'success');
        log('='.repeat(60), 'info');
        log(`âœ… ì—…ë°ì´íŠ¸ë¨: ${updatedCount}ê±´`, 'success');
        log(`â­ï¸  ê±´ë„ˆëœ€: ${skippedCount}ê±´`, 'info');
        log(`âŒ ì˜¤ë¥˜: ${errorCount}ê±´`, 'error');
        log(`ğŸ“¦ ì „ì²´: ${totalOrders}ê±´`, 'info');
        log('='.repeat(60), 'info');
        log('', 'info');
        log('ğŸ‰ ë§ˆì´ê·¸ë ˆì´ì…˜ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
        log('ğŸ’¡ í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ì—¬ ë³€ê²½ì‚¬í•­ì„ í™•ì¸í•˜ì„¸ìš”.', 'info');

        progressEl.textContent = `ì™„ë£Œ! ${updatedCount}ê±´ ì—…ë°ì´íŠ¸ë¨`;
        document.getElementById('migrateBtn').disabled = false;

      } catch (error) {
        log(`\nâŒ ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤íŒ¨: ${error.message}`, 'error');
        console.error('Migration error:', error);
        progressEl.textContent = 'ì˜¤ë¥˜ ë°œìƒ';
        document.getElementById('migrateBtn').disabled = false;
      }
    };
  </script>
  <style>
    body {
      font-family: 'Noto Sans KR', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      max-width: 1000px;
      margin: 40px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h1 {
      color: #1f2937;
      margin-bottom: 10px;
    }
    .warning {
      background: #fef3c7;
      border-left: 4px solid #f59e0b;
      padding: 16px;
      margin: 20px 0;
      border-radius: 4px;
    }
    .info {
      background: #dbeafe;
      border-left: 4px solid #3b82f6;
      padding: 16px;
      margin: 20px 0;
      border-radius: 4px;
    }
    button {
      background: #3b82f6;
      color: white;
      border: none;
      padding: 12px 24px;
      font-size: 16px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      transition: background 0.2s;
    }
    button:hover:not(:disabled) {
      background: #2563eb;
    }
    button:disabled {
      background: #9ca3af;
      cursor: not-allowed;
    }
    #log {
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      padding: 16px;
      margin-top: 20px;
      height: 500px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      line-height: 1.5;
    }
    #progress {
      margin: 16px 0;
      font-weight: 600;
      color: #3b82f6;
    }
    ul {
      margin: 12px 0;
      padding-left: 24px;
    }
    li {
      margin: 8px 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ”§ Assembly ê³µì • ì œê±° ë§ˆì´ê·¸ë ˆì´ì…˜</h1>
    <p style="color: #6b7280;">Firestore ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ assembly ê³µì •ì„ ì œê±°í•©ë‹ˆë‹¤.</p>

    <div class="warning">
      <strong>âš ï¸ ì£¼ì˜ì‚¬í•­</strong>
      <ul>
        <li>ì´ ì‘ì—…ì€ <strong>ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</strong></li>
        <li>ëª¨ë“  ë°œì£¼ ê±´ì—ì„œ "ì¡°ë¦½" ê³µì •ì´ ì˜êµ¬ì ìœ¼ë¡œ ì œê±°ë©ë‹ˆë‹¤</li>
        <li>ì‘ì—… ì „ì— ë°ì´í„° ë°±ì—…ì„ ê¶Œì¥í•©ë‹ˆë‹¤</li>
        <li>ë§ˆì´ê·¸ë ˆì´ì…˜ ì¤‘ì—ëŠ” í˜ì´ì§€ë¥¼ ë‹«ì§€ ë§ˆì„¸ìš”</li>
      </ul>
    </div>

    <div class="info">
      <strong>â„¹ï¸ ì‘ì—… ë‚´ìš©</strong>
      <ul>
        <li><code>orders</code> ì»¬ë ‰ì…˜ì˜ ëª¨ë“  ë¬¸ì„œ ê²€ì‚¬</li>
        <li><code>schedule.production</code> ë°°ì—´ì—ì„œ assembly ê³µì • ì œê±°</li>
        <li><code>orders/{orderId}/processes</code> ì„œë¸Œì»¬ë ‰ì…˜ì—ì„œ assembly ë¬¸ì„œ ì‚­ì œ</li>
      </ul>
    </div>

    <button id="migrateBtn" onclick="this.disabled=true; migrateRemoveAssembly();">
      ğŸš€ ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹œì‘
    </button>

    <div id="progress"></div>

    <div id="log"></div>
  </div>
</body>
</html>
